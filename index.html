<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Programmed Drills(Standard)</title>
    <style>
        :root { 
            --primary: #ff6b4a; 
            --bg: #f5f6fa; 
            --surface: #ffffff; 
            --text: #2d3436; 
            --text-light: #636e72;
            --border: #dfe6e9; 
            --success: #ff6b4a; 
            --danger: #d63031; 
        }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background: var(--bg); 
            color: var(--text); 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            min-height: 100vh; 
            margin: 0; 
            padding: 20px 15px;
            box-sizing: border-box;
        }

        .container { 
            width: 100%; 
            max-width: 500px; 
        }

        /* Header */
        header {
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            margin-bottom: 20px;
        }
        
        h1 { 
            margin: 0; 
            font-size: 1.1rem; 
            font-weight: 600; 
            color: var(--text); 
        }

        .back-arrow {
            position: absolute;
            left: 0;
            font-size: 1.5rem;
            color: #b2bec3;
            cursor: pointer;
        }

        /* Section Label */
        .section-label {
            font-size: 0.9rem;
            color: #b2bec3;
            margin-bottom: 8px;
            padding-left: 5px;
        }

        /* Settings / Connect Box */
        .settings-card { 
            background: #e4e7eb; 
            border-radius: 20px; 
            padding: 15px; 
            margin-bottom: 20px; 
        }

        /* Connect Button */
        .btn-connect { 
            width: 100%; 
            padding: 12px; 
            border: none; 
            border-radius: 25px; 
            font-weight: 600; 
            cursor: pointer; 
            font-size: 0.95rem; 
            background: var(--primary); 
            color: white;
            margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(255, 107, 74, 0.3);
            transition: background 0.2s;
        }
        .btn-connect.connected { background: #00b894; } 

        /* Controls (Level, Reps, Time) */
        .controls-row {
            display: flex;
            gap: 10px;
            margin-bottom: 5px;
        }
        .control-pill {
            background: white;
            border-radius: 15px;
            padding: 10px;
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .control-pill label {
            font-size: 0.7rem;
            color: var(--text-light);
            margin-bottom: 4px;
            text-transform: uppercase;
        }
        
        input[type="number"] {
            border: none;
            font-size: 1rem;
            font-weight: bold;
            color: var(--primary);
            text-align: center;
            width: 100%;
            background: transparent;
        }
        input[type="number"]:focus { outline: none; }

        /* Toggle Switch for Mode */
        .mode-switch {
            display: flex;
            background: #dfe6e9;
            border-radius: 20px;
            padding: 2px;
            width: 100%;
        }
        .mode-option {
            flex: 1;
            text-align: center;
            padding: 6px;
            font-size: 0.75rem;
            border-radius: 18px;
            cursor: pointer;
            color: var(--text-light);
            font-weight: 600;
        }
        .mode-option.active {
            background: white;
            color: var(--primary);
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        /* TABS */
        .tabs-container {
            background: white;
            border-radius: 25px; 
            padding: 4px;
            display: flex;
            justify-content: space-between;
            margin-bottom: 25px;
        }
        
        .tab-btn {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 10px;
            border-radius: 22px;
            border: 1px solid transparent;
            background: transparent;
            color: #b2bec3;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .tab-btn.active {
            background: white;
            border: 1px solid var(--primary);
            color: var(--primary);
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        /* Tab Icons (4 dots) */
        .icon-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2px;
            width: 10px;
            height: 10px;
        }
        .icon-dot {
            background-color: #d3d3d3;
            border-radius: 50%;
        }
        .tab-btn.active .icon-dot {
            background-color: var(--primary);
        }

        /* --- DRILL LIST (GRID LAYOUT) --- */
        .drill-list {
            display: grid;
            grid-template-columns: 1fr 1fr; /* 2 Columns */
            gap: 12px;
        }
        
        .hidden { display: none !important; }

        .btn-drill {
            background: white;
            border: none;
            border-radius: 20px; 
            padding: 15px 10px 15px 10px;
            font-size: 0.8rem;
            font-weight: 600;
            color: #4a4a4a; 
            cursor: pointer;
            display: flex;
            flex-direction: column; 
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.03);
            transition: transform 0.1s, box-shadow 0.1s;
            min-height: 80px; 
            width: 100%;
            position: relative;
        }
        
        .btn-drill span {
            text-align: center;
            line-height: 1.3;
            width: 100%;
        }

        .btn-drill:active { transform: scale(0.98); }
        .btn-drill:disabled { opacity: 0.6; cursor: not-allowed; }

        /* Icon inside drill button (Centered) */
        .btn-drill .drill-icon {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 3px;
            width: 14px;
            height: 14px;
        }
        .btn-drill .drill-icon .d-dot {
            background-color: #cbd5e0;
            border-radius: 50%;
        }

        /* Level Selector Styling */
        .level-select {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 10px;
        }
        .lvl-dot {
            width: 30px; height: 30px;
            border-radius: 50%;
            background: white;
            display: flex; align-items: center; justify-content: center;
            font-size: 0.8rem; font-weight: bold; color: var(--text-light);
            cursor: pointer;
            border: 2px solid transparent;
        }
        .lvl-dot.active {
            border-color: var(--primary);
            color: var(--primary);
        }

        /* Stop Button */
        .btn-stop { 
            background: var(--danger); 
            color: white; 
            width: 100%; 
            padding: 16px; 
            border: none; 
            border-radius: 30px; 
            font-weight: 700; 
            cursor: pointer; 
            font-size: 1rem; 
            margin-top: 25px; 
            box-shadow: 0 4px 10px rgba(214, 48, 49, 0.3);
        }
        .btn-stop:disabled { opacity: 0.5; cursor: not-allowed; background: #fab1a0; box-shadow: none; }

        /* Status text */
        #status-text {
            text-align: center;
            font-size: 0.8rem;
            color: var(--primary);
            font-weight: 600;
            height: 20px;
            margin-bottom: 5px;
        }

        .log-box { margin-top: 20px; background: #2d3436; color: #00cec9; padding: 12px; border-radius: 10px; font-family: monospace; font-size: 0.7rem; height: 100px; overflow-y: auto; display: none; }
        .checkbox-wrapper { margin-top: 20px; display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 0.8rem; color: #b2bec3; }
    </style>
</head>
<body>

<div class="container">
    
    <header>
        <div class="back-arrow">â€¹</div>
        <h1>Programmed Drills(Standard)</h1>
    </header>

    <div class="settings-card">
        <div id="status-text">Disconnected</div>
        <button id="btn-connect" class="btn-connect">Connect</button>

        <div class="control-group">
            <div style="text-align:center; font-size:0.7rem; color:#636e72; margin-bottom:5px;">DIFFICULTY LEVEL</div>
            <div class="level-select">
                <div class="lvl-dot active" onclick="setLevel(1, this)">1</div>
                <div class="lvl-dot" onclick="setLevel(2, this)">2</div>
                <div class="lvl-dot" onclick="setLevel(3, this)">3</div>
            </div>
        </div>

        <div class="control-pill" style="margin-bottom: 10px;">
            <div class="mode-switch">
                <div class="mode-option active" onclick="setMode('reps', this)">Reps</div>
                <div class="mode-option" onclick="setMode('time', this)">Time</div>
            </div>
        </div>

        <div class="controls-row">
            <div class="control-pill" id="ui-reps">
                <label>Count</label>
                <input type="number" id="input-reps" value="10">
            </div>
            <div class="control-pill hidden" id="ui-time">
                <label>Time (s)</label>
                <input type="number" id="input-time" value="60" step="10">
            </div>
            <div class="control-pill">
                <label>Pause (ms)</label>
                <input type="number" id="input-pause" value="1000" step="100">
            </div>
        </div>
        
        </div>

    <div class="section-label">Technique Selection</div>
    <div class="settings-card" style="padding: 5px; border-radius: 30px; background: #e4e7eb;">
        <div class="tabs-container" style="margin-bottom:0; background: transparent;">
            <div class="tab-btn active" onclick="switchTab('basic', this)">
                <div class="icon-grid"><div class="icon-dot"></div><div class="icon-dot"></div><div class="icon-dot"></div><div class="icon-dot"></div></div>
                Basic
            </div>
            <div class="tab-btn" onclick="switchTab('combined', this)">
                <div class="icon-grid"><div class="icon-dot"></div><div class="icon-dot"></div><div class="icon-dot"></div><div class="icon-dot"></div></div>
                Combined
            </div>
            <div class="tab-btn" onclick="switchTab('complex', this)">
                <div class="icon-grid"><div class="icon-dot"></div><div class="icon-dot"></div><div class="icon-dot"></div><div class="icon-dot"></div></div>
                Complex
            </div>
        </div>
    </div>

    <div id="view-basic" class="drill-list">
        <button class="btn-drill" data-key="push(b)" disabled>
            <div class="drill-icon"><div class="d-dot"></div><div class="d-dot"></div><div class="d-dot"></div><div class="d-dot"></div></div>
            <span>Push (B)</span>
        </button>
        <button class="btn-drill" data-key="push(f)" disabled>
            <div class="drill-icon"><div class="d-dot"></div><div class="d-dot"></div><div class="d-dot"></div><div class="d-dot"></div></div>
            <span>Push (F)</span>
        </button>
        <button class="btn-drill" data-key="drive(b)" disabled>
            <div class="drill-icon"><div class="d-dot"></div><div class="d-dot"></div><div class="d-dot"></div><div class="d-dot"></div></div>
            <span>Drive (B)</span>
        </button>
        <button class="btn-drill" data-key="drive(f)" disabled>
            <div class="drill-icon"><div class="d-dot"></div><div class="d-dot"></div><div class="d-dot"></div><div class="d-dot"></div></div>
            <span>Drive (F)</span>
        </button>
        <button class="btn-drill" data-key="loop(b)" disabled>
            <div class="drill-icon"><div class="d-dot"></div><div class="d-dot"></div><div class="d-dot"></div><div class="d-dot"></div></div>
            <span>Loop (B)</span>
        </button>
        <button class="btn-drill" data-key="loop(f)" disabled>
            <div class="drill-icon"><div class="d-dot"></div><div class="d-dot"></div><div class="d-dot"></div><div class="d-dot"></div></div>
            <span>Loop (F)</span>
        </button>
    </div>

    <div id="view-combined" class="drill-list hidden">
        <button class="btn-drill" data-key="loop(b)-drive(b)" disabled><div class="drill-icon"><div class="d-dot"></div><div class="d-dot"></div><div class="d-dot"></div><div class="d-dot"></div></div><span>Loop(B) Drive(B)</span></button>
        <button class="btn-drill" data-key="loop(f)-drive(f)" disabled><div class="drill-icon"><div class="d-dot"></div><div class="d-dot"></div><div class="d-dot"></div><div class="d-dot"></div></div><span>Loop(F) Drive(F)</span></button>
        <button class="btn-drill" data-key="drive(f)-drive(b)" disabled><div class="drill-icon"><div class="d-dot"></div><div class="d-dot"></div><div class="d-dot"></div><div class="d-dot"></div></div><span>Drive(F) Drive(B)</span></button>
        <button class="btn-drill" data-key="push(f)-drive(f)" disabled><div class="drill-icon"><div class="d-dot"></div><div class="d-dot"></div><div class="d-dot"></div><div class="d-dot"></div></div><span>Push(F) Drive(F)</span></button>
        <button class="btn-drill" data-key="push(b)-loop(b)" disabled><div class="drill-icon"><div class="d-dot"></div><div class="d-dot"></div><div class="d-dot"></div><div class="d-dot"></div></div><span>Push(B) Loop(B)</span></button>
        <button class="btn-drill" data-key="loop(f)-drive(b)" disabled><div class="drill-icon"><div class="d-dot"></div><div class="d-dot"></div><div class="d-dot"></div><div class="d-dot"></div></div><span>Loop(F) Drive(B)</span></button>
        <button class="btn-drill" data-key="push(f)-loop(b)" disabled><div class="drill-icon"><div class="d-dot"></div><div class="d-dot"></div><div class="d-dot"></div><div class="d-dot"></div></div><span>Push(F) Loop(B)</span></button>
        <button class="btn-drill" data-key="drive(f)-drive(f)" disabled><div class="drill-icon"><div class="d-dot"></div><div class="d-dot"></div><div class="d-dot"></div><div class="d-dot"></div></div><span>Drive(F) Drive(F)</span></button>
        <button class="btn-drill" data-key="push(b)-loop(f)" disabled><div class="drill-icon"><div class="d-dot"></div><div class="d-dot"></div><div class="d-dot"></div><div class="d-dot"></div></div><span>Push(B) Loop(F)</span></button>
        <button class="btn-drill" data-key="push(f)-loop(f)" disabled><div class="drill-icon"><div class="d-dot"></div><div class="d-dot"></div><div class="d-dot"></div><div class="d-dot"></div></div><span>Push(F) Loop(F)</span></button>
        <button class="btn-drill" data-key="loop(f)-loop(f)" disabled><div class="drill-icon"><div class="d-dot"></div><div class="d-dot"></div><div class="d-dot"></div><div class="d-dot"></div></div><span>Loop(F) Loop(F)</span></button>
        <button class="btn-drill" data-key="loop(b)-drive(f)" disabled><div class="drill-icon"><div class="d-dot"></div><div class="d-dot"></div><div class="d-dot"></div><div class="d-dot"></div></div><span>Loop(B) Drive(F)</span></button>
    </div>

    <div id="view-complex" class="drill-list hidden">
        <button class="btn-drill" data-key="push(b)-loop(f)-drive(b)" disabled><div class="drill-icon"><div class="d-dot"></div><div class="d-dot"></div><div class="d-dot"></div><div class="d-dot"></div></div><span>Push(B)-Loop(F) Drive(B)</span></button>
        <button class="btn-drill" data-key="push(f)-loop(b)-drive(f)" disabled><div class="drill-icon"><div class="d-dot"></div><div class="d-dot"></div><div class="d-dot"></div><div class="d-dot"></div></div><span>Push(F)-Loop(B) Drive(F)</span></button>
        <button class="btn-drill" data-key="loop(f)-drive(f)-drive(b)" disabled><div class="drill-icon"><div class="d-dot"></div><div class="d-dot"></div><div class="d-dot"></div><div class="d-dot"></div></div><span>Loop(F)-Drive(F) Drive(B)</span></button>
        <button class="btn-drill" data-key="loop(b)-drive(f)-drive(b)" disabled><div class="drill-icon"><div class="d-dot"></div><div class="d-dot"></div><div class="d-dot"></div><div class="d-dot"></div></div><span>Loop(B)-Drive(F) Drive(B)</span></button>
        <button class="btn-drill" data-key="drive(f)-drive(f)-drive(f)" disabled><div class="drill-icon"><div class="d-dot"></div><div class="d-dot"></div><div class="d-dot"></div><div class="d-dot"></div></div><span>Drive(F) 3x</span></button>
        
        <button class="btn-drill" data-key="push(f)-loop(f)-drive(f)" disabled><div class="drill-icon"><div class="d-dot"></div><div class="d-dot"></div><div class="d-dot"></div><div class="d-dot"></div></div><span>Push(F)-Loop(F) Drive(F)</span></button>
        <button class="btn-drill" data-key="push(b)-loop(b)-drive(b)" disabled><div class="drill-icon"><div class="d-dot"></div><div class="d-dot"></div><div class="d-dot"></div><div class="d-dot"></div></div><span>Push(B)-Loop(B) Drive(B)</span></button>
        <button class="btn-drill" data-key="push(f)-loop(b)-drive(b)" disabled><div class="drill-icon"><div class="d-dot"></div><div class="d-dot"></div><div class="d-dot"></div><div class="d-dot"></div></div><span>Push(F)-Loop(B) Drive(B)</span></button>
        <button class="btn-drill" data-key="loop(f)-drive(b)-drive(f)" disabled><div class="drill-icon"><div class="d-dot"></div><div class="d-dot"></div><div class="d-dot"></div><div class="d-dot"></div></div><span>Loop(F)-Drive(B) Drive(F)</span></button>
        <button class="btn-drill" data-key="loop(b)-drive(b)-drive(f)" disabled><div class="drill-icon"><div class="d-dot"></div><div class="d-dot"></div><div class="d-dot"></div><div class="d-dot"></div></div><span>Loop(B)-Drive(B) Drive(F)</span></button>
        <button class="btn-drill" data-key="push(b)-loop(f)-drive(f)" disabled><div class="drill-icon"><div class="d-dot"></div><div class="d-dot"></div><div class="d-dot"></div><div class="d-dot"></div></div><span>Push(B)-Loop(F) Drive(F)</span></button>
        <button class="btn-drill" data-key="push(b)-loop(b)-drive(f)" disabled><div class="drill-icon"><div class="d-dot"></div><div class="d-dot"></div><div class="d-dot"></div><div class="d-dot"></div></div><span>Push(B)-Loop(B) Drive(F)</span></button>
        <button class="btn-drill" data-key="drive(b)-drive(f)-drive(f)" disabled><div class="drill-icon"><div class="d-dot"></div><div class="d-dot"></div><div class="d-dot"></div><div class="d-dot"></div></div><span>Drive(B)-Drive(F) Drive(F)</span></button>
        
        <button class="btn-drill" data-key="random-drive" disabled><div class="drill-icon"><div class="d-dot"></div><div class="d-dot"></div><div class="d-dot"></div><div class="d-dot"></div></div><span>Random Drive</span></button>
        <button class="btn-drill" data-key="23-random-drive" disabled><div class="drill-icon"><div class="d-dot"></div><div class="d-dot"></div><div class="d-dot"></div><div class="d-dot"></div></div><span>2/3 Court Random Drive</span></button>
        <button class="btn-drill" data-key="all-random" disabled><div class="drill-icon"><div class="d-dot"></div><div class="d-dot"></div><div class="d-dot"></div><div class="d-dot"></div></div><span>All Random</span></button>
    </div>

    <button id="btn-stop" class="btn-stop" disabled>STOP</button>

    <div class="checkbox-wrapper">
        <input type="checkbox" id="chk-console"> Show Log
    </div>
    <div id="log" class="log-box"></div>
</div>

<script>
    // --- Config ---
    const SERVICE = 0xfeff;
    const UUID_S  = "02f00000-0000-0000-0000-00000000fe00";
    const UUID_N  = "02f00000-0000-0000-0000-00000000ff02";
    const UUID_W  = "02f00000-0000-0000-0000-00000000ff01";
    const SALT    = "Mjgx1jAwXDBaMFcxCz3JBgNVBAYT4kJF7Rkw";
    const MSG_DONE = "00020300050100";

    // --- State ---
    let device, notifyChar, writeChar;
    let writeLock = Promise.resolve();
    let state = "disconnected";
    let isRunning = false;
    let currentCount = 0;
    let targetCount = 0;
    let pauseTimer = null;
    let activeDrillParams = null;
    let runMode = "reps"; 
    let endTime = 0;
    let selectedLevel = 1;

    // --- UI Helpers ---
    const ui = {
        connect: document.getElementById('btn-connect'),
        statusText: document.getElementById('status-text'),
        log: document.getElementById('log'),
        drillBtns: document.querySelectorAll('.btn-drill'),
        stop: document.getElementById('btn-stop'),
        inputPause: document.getElementById('input-pause')
    };

    function log(msg) {
        const t = new Date().toLocaleTimeString().split(' ')[0];
        ui.log.textContent += `\n[${t}] ${msg}`;
        ui.log.scrollTop = ui.log.scrollHeight;
    }

    // --- Interactivity ---
    function switchTab(catName, btn) {
        document.getElementById('view-basic').classList.add('hidden');
        document.getElementById('view-combined').classList.add('hidden');
        document.getElementById('view-complex').classList.add('hidden');
        document.getElementById('view-' + catName).classList.remove('hidden');
        document.querySelectorAll('.tab-btn').forEach(t => t.classList.remove('active'));
        btn.classList.add('active');
    }

    function setLevel(lvl, btn) {
        selectedLevel = lvl;
        document.querySelectorAll('.lvl-dot').forEach(d => d.classList.remove('active'));
        btn.classList.add('active');
    }

    function setMode(mode, btn) {
        runMode = mode;
        document.querySelectorAll('.mode-option').forEach(d => d.classList.remove('active'));
        btn.classList.add('active');
        if(mode === 'reps') {
            document.getElementById('ui-reps').classList.remove('hidden');
            document.getElementById('ui-time').classList.add('hidden');
        } else {
            document.getElementById('ui-reps').classList.add('hidden');
            document.getElementById('ui-time').classList.remove('hidden');
        }
    }

    ui.inputPause.onchange = (e) => {
        let val = parseInt(e.target.value);
        if(val < 500) val = 500;
        if(val > 5000) val = 5000;
        ui.inputPause.value = val;
    };

    document.getElementById('chk-console').onchange = (e) => {
        ui.log.style.display = e.target.checked ? 'block' : 'none';
    };

    ui.connect.onclick = () => {
        if (device && device.gatt.connected) device.gatt.disconnect();
        else connect();
    };

    ui.stop.onclick = stop;

    ui.drillBtns.forEach(btn => {
        btn.onclick = () => {
            const drillName = btn.getAttribute('data-key');
            startDrillSequence(drillName);
        };
    });

    // --- Bluetooth ---
    async function connect() {
        try {
            log("Scanning...");
            device = await navigator.bluetooth.requestDevice({
                filters: [{ services: [SERVICE] }],
                optionalServices: [UUID_S]
            });
            device.addEventListener('gattserverdisconnected', onDisconnect);
            const server = await device.gatt.connect();
            const service = await server.getPrimaryService(UUID_S);
            
            const chars = await service.getCharacteristics();
            for(let c of chars) {
                if(c.uuid === UUID_N) {
                    notifyChar = c;
                    await c.startNotifications();
                    c.addEventListener('characteristicvaluechanged', onNotify);
                }
                if(c.uuid === UUID_W) writeChar = c;
            }

            if(notifyChar && writeChar) {
                log("Handshake...");
                state = "handshake";
                send([0x07,0,0,0]);
            }
        } catch(e) { log("Err: " + e.message); }
    }

    function onDisconnect() {
        state = "disconnected";
        ui.statusText.textContent = "Disconnected";
        ui.statusText.style.color = "#b2bec3";
        ui.connect.textContent = "Connect";
        ui.connect.classList.remove('connected');
        toggleControls(false);
        isRunning = false;
        clearTimeout(pauseTimer);
    }

    function toggleControls(enable) {
        ui.drillBtns.forEach(b => b.disabled = !enable);
        ui.stop.disabled = !enable;
    }

    async function send(data) {
        if(!writeChar) return;
        const arr = new Uint8Array(data);
        writeLock = writeLock.then(() => writeChar.writeValue(arr).catch(e => log("TX Fail: "+e)));
        return writeLock;
    }

    function onNotify(e) {
        const buf = e.target.value.buffer;
        const hex = [...new Uint8Array(buf)].map(b => b.toString(16).padStart(2,'0')).join('');

        if(state === "handshake") {
            const td = new TextDecoder();
            const serial = td.decode(buf.slice(6,18));
            const code = td.decode(buf.slice(18));
            if(serial && code) {
                let hashme = serial;
                for(let i=0; i<serial.length; i++) hashme += SALT[serial.charCodeAt(i)%0x24];
                hashme += code;
                const hash = MD5(hashme);
                const resp = new Uint8Array(3+hash.length);
                resp.set([0x08,0x20,0,0]);
                resp.set(new TextEncoder().encode(hash),3);
                send(resp);
                state = "auth_1";
            }
        } else if(state === "auth_1") { send([1,0,0]); state = "auth_2"; }
        else if(state === "auth_2") { send([2,0,0]); state = "auth_3"; }
        else if(state === "auth_3") {
            send([0x80,1,0,0]);
            state = "ready";
            ui.statusText.textContent = "Connected";
            ui.statusText.style.color = "#00b894";
            ui.connect.textContent = "Disconnect";
            ui.connect.classList.add('connected');
            toggleControls(true);
            log("Ready.");
        }

        if(isRunning && hex.includes(MSG_DONE)) {
            handleDone();
        }
    }

    // --- Logic ---
    function startDrillSequence(drillName) {
        if(state !== "ready") return;

        const params = DRILLS[drillName] ? DRILLS[drillName][selectedLevel] : null;
        if(!params) { log("Drill data missing"); return; }
        
        activeDrillParams = params;
        
        if (runMode === 'time') {
            const tVal = document.getElementById('input-time').value;
            endTime = Date.now() + (parseInt(tVal) * 1000);
            ui.statusText.textContent = `Running (${tVal}s)`;
        } else {
            targetCount = parseInt(document.getElementById('input-reps').value) || 1;
            currentCount = 0;
            ui.statusText.textContent = `Running (0/${targetCount})`;
        }

        isRunning = true;
        ui.drillBtns.forEach(b => b.disabled = true);
        ui.stop.disabled = false;
        runIteration();
    }

    async function runIteration() {
        if(!isRunning) return;
        
        if (runMode === 'time') {
            if (Date.now() >= endTime) { stop(); return; }
        } else {
            currentCount++;
            ui.statusText.textContent = `Running (${currentCount}/${targetCount})`;
        }
        
        const balls = [];
        activeDrillParams.forEach(p => balls.push(packBall(p[0], p[1], p[2], p[3], p[4], p[5])));
        await send(buildPacket(balls));
    }

    function handleDone() {
        if(!isRunning) return;

        if (runMode === 'reps' && currentCount >= targetCount) {
            stop();
            return;
        }
        if (runMode === 'time' && Date.now() >= endTime) {
            stop();
            return;
        }

        const pause = parseInt(ui.inputPause.value);
        ui.statusText.textContent = "Pausing...";
        pauseTimer = setTimeout(() => {
            if(isRunning) runIteration();
        }, pause);
    }

    async function stop() {
        isRunning = false;
        clearTimeout(pauseTimer);
        await send([0x80,1,0,1]);
        ui.statusText.textContent = "Ready";
        ui.drillBtns.forEach(b => b.disabled = false);
        log("Stopped.");
    }

    function packBall(us, ls, bh, dp, freq, reps) {
        const b = new ArrayBuffer(24), v = new DataView(b);
        v.setUint32(0, us, true); 
        v.setUint32(4, ls, true);
        v.setFloat32(8, (bh+50)/150*50-20, true);
        v.setFloat32(12, (dp+10)/20*44-22, true);
        v.setFloat32(16, (freq/100)+0.5, true);
        v.setUint32(20, reps, true);
        return new Uint8Array(b);
    }

    function buildPacket(balls) {
        const b = new ArrayBuffer(7 + balls.length*24);
        const v = new DataView(b);
        v.setUint8(0, 0x81);
        v.setUint16(1, 4+balls.length*24, true);
        v.setUint8(3, 1); 
        v.setUint16(4, 1, true); 
        v.setUint8(6, 0);
        const u = new Uint8Array(b);
        let off = 7;
        balls.forEach(ba => { u.set(ba, off); off+=24; });
        return u;
    }

    // --- DRILL DATA ---
    const DRILLS = {
        "push(b)": { 1: [[1547, 2915, 50, -5, 0, 1]], 2: [[1205, 3257, 50, -5, 10, 1]], 3: [[863, 3599, 50, -5, 10, 1]] },
        "push(f)": { 1: [[1547, 2915, 50, 5, 0, 1]], 2: [[1205, 3257, 50, 5, 10, 1]], 3: [[863, 3599, 50, 5, 10, 1]] },
        "drive(b)": { 1: [[3545, 2177, 60, -5, 20, 1]], 2: [[3545, 2177, 50, -5, 40, 1]], 3: [[3545, 2177, 50, -5, 70, 1]] },
        "drive(f)": { 1: [[3545, 2177, 50, 1, 20, 1]], 2: [[3545, 2177, 50, 0, 40, 1]], 3: [[3545, 2177, 50, 5, 70, 1]] },
        "loop(f)": { 1: [[1520, 3572, 50, 5, 0, 1]], 2: [[1178, 3914, 50, 5, 10, 1]], 3: [[836, 4256, 50, 5, 10, 1]] },
        "loop(b)": { 1: [[1520, 3572, 50, -5, 0, 1]], 2: [[1178, 3914, 50, -5, 10, 1]], 3: [[836, 4256, 50, -5, 10, 1]] },
        "loop(b)-drive(b)": { 1: [[1520, 3572, 50, -5, 0, 1], [3545, 2177, 50, -5, 30, 1]], 2: [[1178, 3914, 50, -5, 10, 1], [3545, 2177, 50, -5, 60, 1]], 3: [[836, 4256, 50, -5, 10, 1], [3545, 2177, 50, -5, 80, 1]] },
        "loop(f)-drive(f)": { 1: [[1520, 3572, 50, 5, 0, 1], [3545, 2177, 50, 5, 30, 1]], 2: [[1178, 3914, 50, 5, 10, 1], [3545, 2177, 50, 5, 60, 1]], 3: [[836, 4256, 50, 5, 10, 1], [3545, 2177, 50, 5, 80, 1]] },
        "drive(f)-drive(b)": { 1: [[3545, 2177, 50, 5, 30, 1], [3545, 2177, 50, -5, 30, 1]], 2: [[3545, 2177, 50, 5, 60, 1], [3545, 2177, 50, -5, 60, 1]], 3: [[3545, 2177, 50, 5, 80, 1], [3545, 2177, 50, -5, 80, 1]] },
        "push(f)-drive(f)": { 1: [[1547, 2915, 50, 5, 0, 1], [3545, 2177, 50, 0, 30, 1]], 2: [[1205, 3257, 50, 5, 10, 1], [3545, 2177, 50, 0, 60, 1]], 3: [[863, 3599, 50, 5, 10, 1], [3545, 2177, 50, 0, 80, 1]] },
        "push(b)-loop(b)": { 1: [[1547, 2915, 50, -5, 10, 1], [1520, 3572, 50, -5, 10, 1]], 2: [[1205, 3257, 50, -5, 10, 1], [1178, 3914, 50, -5, 20, 1]], 3: [[863, 3599, 50, -5, 10, 1], [836, 4256, 50, -5, 20, 1]] },
        "loop(f)-drive(b)": { 1: [[1520, 3572, 50, 5, 0, 1], [3545, 2177, 50, -5, 30, 1]], 2: [[1178, 3914, 50, 5, 10, 1], [3545, 2177, 50, -5, 60, 1]], 3: [[836, 4256, 50, 5, 10, 1], [3545, 2177, 50, -5, 80, 1]] },
        "push(f)-loop(b)": { 1: [[1547, 2915, 50, 5, 10, 1], [1520, 3572, 50, -5, 10, 1]], 2: [[1205, 3257, 50, 5, 10, 1], [1178, 3914, 50, -5, 20, 1]], 3: [[863, 3599, 50, 5, 10, 1], [836, 4256, 50, -5, 20, 1]] },
        "drive(f)-drive(f)": { 1: [[3545, 2177, 50, 2, 30, 1], [3545, 2177, 50, -3, 30, 1]], 2: [[3545, 2177, 50, 5, 60, 1], [3545, 2177, 50, 0, 60, 1]], 3: [[3545, 2177, 50, 5, 80, 1], [3545, 2177, 50, 0, 80, 1]] },
        "push(b)-loop(f)": { 1: [[1547, 2915, 50, -5, 10, 1], [1520, 3572, 50, 5, 10, 1]], 2: [[1205, 3257, 50, -5, 10, 1], [1178, 3914, 50, 5, 20, 1]], 3: [[863, 3599, 50, -5, 10, 1], [836, 4256, 50, 5, 20, 1]] },
        "push(f)-loop(f)": { 1: [[1547, 2915, 44, 5, 10, 1], [1520, 3572, 44, 5, 10, 1]], 2: [[1205, 3257, 50, 5, 10, 1], [1178, 3914, 50, 5, 20, 1]], 3: [[863, 3599, 50, 5, 10, 1], [836, 4256, 50, 5, 20, 1]] },
        "loop(f)-loop(f)": { 1: [[1520, 3572, 50, 5, 0, 1], [1520, 3572, 50, 0, 0, 1]], 2: [[1178, 3914, 50, 5, 10, 1], [1178, 3914, 50, 0, 10, 1]], 3: [[836, 4256, 50, 5, 10, 1], [836, 4256, 50, 0, 10, 1]] },
        "loop(b)-drive(f)": { 1: [[1520, 3572, 50, -5, 0, 1], [3545, 2177, 50, 5, 30, 1]], 2: [[1178, 3914, 50, -5, 10, 1], [3545, 2177, 50, 5, 60, 1]], 3: [[836, 4256, 50, -5, 10, 1], [3545, 2177, 50, 5, 80, 1]] },
        "push(b)-loop(f)-drive(b)": { 1: [[1547, 2915, 50, -5, 0, 1], [1520, 3572, 50, 5, 10, 1], [3545, 2177, 50, -5, 30, 1]], 2: [[1205, 3257, 50, -5, 10, 1], [1178, 3914, 50, 5, 10, 1], [3545, 2177, 50, -5, 60, 1]], 3: [[863, 3599, 50, -5, 10, 1], [836, 4256, 50, 5, 10, 1], [3545, 2177, 50, -5, 80, 1]] },
        "push(f)-loop(b)-drive(f)": { 1: [[1547, 2915, 50, 5, 0, 1], [1520, 3572, 50, -5, 10, 1], [3545, 2177, 50, 5, 30, 1]], 2: [[1205, 3257, 50, 5, 10, 1], [1178, 3914, 50, -5, 10, 1], [3545, 2177, 50, 5, 60, 1]], 3: [[863, 3599, 50, 5, 10, 1], [836, 4256, 50, -5, 10, 1], [3545, 2177, 50, 5, 80, 1]] },
        "loop(f)-drive(f)-drive(b)": { 1: [[1520, 3572, 50, 5, 0, 1], [3545, 2177, 50, 5, 10, 1], [3545, 2177, 50, -5, 30, 1]], 2: [[1178, 3914, 50, 5, 10, 1], [3545, 2177, 50, 5, 10, 1], [3545, 2177, 50, -5, 60, 1]], 3: [[836, 4256, 50, 5, 10, 1], [3545, 2177, 50, 5, 10, 1], [3545, 2177, 50, -5, 80, 1]] },
        "loop(b)-drive(f)-drive(b)": { 1: [[1520, 3572, 50, -5, 0, 1], [3545, 2177, 50, 5, 10, 1], [3545, 2177, 50, -5, 30, 1]], 2: [[1178, 3914, 50, -5, 10, 1], [3545, 2177, 50, 5, 10, 1], [3545, 2177, 50, -5, 60, 1]], 3: [[836, 4256, 50, -5, 10, 1], [3545, 2177, 50, 5, 10, 1], [3545, 2177, 50, -5, 80, 1]] },
        "drive(f)-drive(f)-drive(f)": { 1: [[3545, 2177, 50, 5, 30, 1], [3545, 2177, 50, 0, 30, 1], [3545, 2177, 50, -5, 30, 1]], 2: [[3545, 2177, 50, 5, 60, 1], [3545, 2177, 50, 0, 60, 1], [3545, 2177, 50, -5, 60, 1]], 3: [[3545, 2177, 50, 5, 80, 1], [3545, 2177, 50, 0, 80, 1], [3545, 2177, 50, -5, 80, 1]] },
        "push(f)-loop(f)-drive(f)": { 1: [[1547, 2915, 50, 5, 0, 1], [1520, 3572, 50, 5, 10, 1], [3545, 2177, 50, 5, 30, 1]], 2: [[1205, 3257, 50, 5, 10, 1], [1178, 3914, 50, 5, 10, 1], [3545, 2177, 50, 5, 60, 1]], 3: [[863, 3599, 50, 5, 10, 1], [836, 4256, 50, 5, 10, 1], [3545, 2177, 50, 5, 80, 1]] },
        "push(b)-loop(b)-drive(b)": { 1: [[1547, 2915, 50, -5, 0, 1], [1520, 3572, 50, -5, 10, 1], [3545, 2177, 50, -5, 30, 1]], 2: [[1205, 3257, 50, -5, 10, 1], [1178, 3914, 50, -5, 10, 1], [3545, 2177, 50, -5, 60, 1]], 3: [[863, 3599, 50, -5, 10, 1], [836, 4256, 50, -5, 10, 1], [3545, 2177, 50, -5, 80, 1]] },
        "push(f)-loop(b)-drive(b)": { 1: [[1547, 2915, 50, 5, 0, 1], [1520, 3572, 50, -5, 10, 1], [3545, 2177, 50, -5, 30, 1]], 2: [[1205, 3257, 50, 5, 10, 1], [1178, 3914, 50, -5, 10, 1], [3545, 2177, 50, -5, 60, 1]], 3: [[863, 3599, 50, 5, 10, 1], [836, 4256, 50, -5, 10, 1], [3545, 2177, 50, -5, 80, 1]] },
        "loop(f)-drive(b)-drive(f)": { 1: [[1520, 3572, 50, 5, 0, 1], [3545, 2177, 50, -5, 10, 1], [3545, 2177, 50, 5, 30, 1]], 2: [[1178, 3914, 50, 5, 10, 1], [3545, 2177, 50, -5, 10, 1], [3545, 2177, 50, 5, 60, 1]], 3: [[836, 4256, 50, 5, 10, 1], [3545, 2177, 50, -5, 10, 1], [3545, 2177, 50, 5, 80, 1]] },
        "loop(b)-drive(b)-drive(f)": { 1: [[1520, 3572, 48, -5, 0, 1], [3545, 2177, 48, -5, 10, 1], [3545, 2177, 48, 5, 30, 1]], 2: [[1178, 3914, 50, -5, 10, 1], [3545, 2177, 50, -5, 10, 1], [3545, 2177, 50, 5, 60, 1]], 3: [[836, 4256, 50, -5, 10, 1], [3545, 2177, 50, -5, 10, 1], [3545, 2177, 50, 5, 80, 1]] },
        "push(b)-loop(f)-drive(f)": { 1: [[1547, 2915, 50, -5, 0, 1], [1520, 3572, 50, 5, 10, 1], [3545, 2177, 50, 5, 30, 1]], 2: [[1205, 3257, 50, -5, 10, 1], [1178, 3914, 50, 5, 10, 1], [3545, 2177, 50, 5, 60, 1]], 3: [[863, 3599, 50, -5, 10, 1], [836, 4256, 50, 5, 10, 1], [3545, 2177, 50, 5, 80, 1]] },
        "push(b)-loop(b)-drive(f)": { 1: [[1547, 2915, 50, -5, 0, 1], [1520, 3572, 50, -5, 10, 1], [3545, 2177, 50, 5, 30, 1]], 2: [[1205, 3257, 50, -5, 10, 1], [1178, 3914, 50, -5, 10, 1], [3545, 2177, 50, 5, 60, 1]], 3: [[863, 3599, 50, -5, 10, 1], [836, 4256, 50, -5, 10, 1], [3545, 2177, 50, 5, 80, 1]] },
        "drive(b)-drive(f)-drive(f)": { 1: [[3545, 2177, 50, -5, 0, 1], [3545, 2177, 50, -5, 10, 1], [3545, 2177, 50, 5, 30, 1]], 2: [[3545, 2177, 50, -5, 10, 1], [3545, 2177, 50, -5, 10, 1], [3545, 2177, 50, 5, 60, 1]], 3: [[3545, 2177, 50, -5, 10, 1], [3545, 2177, 50, -5, 10, 1], [3545, 2177, 50, 5, 80, 1]] },
        "random-drive": { 1: [[3545, 2177, 46, 5, 30, 1], [3545, 2177, 46, 0, 30, 1], [3545, 2177, 46, -5, 30, 1]], 2: [[3545, 2177, 50, 5, 60, 1], [3545, 2177, 50, 0, 60, 1], [3545, 2177, 50, -5, 60, 1]], 3: [[3545, 2177, 50, 5, 80, 1], [3545, 2177, 50, 0, 80, 1], [3545, 2177, 50, -5, 80, 1]] },
        "23-random-drive": { 1: [[3545, 2177, 50, 5, 30, 1], [3545, 2177, 50, 3, 30, 1], [3545, 2177, 50, 1, 30, 1], [3545, 2177, 50, -1, 30, 1]], 2: [[3545, 2177, 50, 5, 60, 1], [3545, 2177, 50, 3, 60, 1], [3545, 2177, 50, 1, 60, 1], [3545, 2177, 50, -1, 60, 1]], 3: [[3545, 2177, 50, 5, 80, 1], [3545, 2177, 50, 3, 80, 1], [3545, 2177, 50, 1, 80, 1], [3545, 2177, 50, -1, 80, 1]] },
        "all-random": { 1: [[1547, 2915, 50, 5, 10, 1], [1547, 2915, 50, -5, 10, 1], [3545, 2177, 50, 5, 40, 1], [3545, 2177, 50, 0, 40, 1], [3545, 2177, 50, -5, 40, 1]], 2: [[1205, 3257, 50, 5, 10, 1], [1205, 3257, 50, -5, 10, 1], [3545, 2177, 50, 5, 50, 1], [3545, 2177, 50, 0, 50, 1], [3545, 2177, 50, -5, 50, 1]], 3: [[863, 3599, 50, 5, 10, 1], [863, 3599, 50, -5, 10, 1], [3545, 2177, 50, 5, 80, 1], [3545, 2177, 50, 0, 80, 1], [3545, 2177, 50, -5, 80, 1]] }
    };

    // --- MD5 & Crypto ---
    var MD5=function(d){var r=M(V(Y(X(d),8*d.length)));return r.toLowerCase()};function M(d){for(var _,m="0123456789ABCDEF",f="",r=0;r<d.length;r++)_=d.charCodeAt(r),f+=m.charAt(_>>>4&15)+m.charAt(15&_);return f}function X(d){for(var _=Array(d.length>>2),m=0;m<_.length;m++)_[m]=0;for(m=0;m<8*d.length;m+=8)_[m>>5]|=(255&d.charCodeAt(m/8))<<m%32;return _}function V(d){for(var _="",m=0;m<32*d.length;m+=8)_+=String.fromCharCode(d[m>>5]>>>m%32&255);return _}function Y(d,_){d[_>>5]|=128<<_%32,d[14+(_+64>>>9<<4)]=_;for(var m=1732584193,f=-271733879,r=-1732584194,i=271733878,n=0;n<d.length;n+=16){var h=m,t=f,g=r,e=i;f=md5_ii(f=md5_ii(f=md5_ii(f=md5_ii(f=md5_hh(f=md5_hh(f=md5_hh(f=md5_hh(f=md5_gg(f=md5_gg(f=md5_gg(f=md5_gg(f=md5_ff(f=md5_ff(f=md5_ff(f=md5_ff(f,r=md5_ff(r,i=md5_ff(i,m=md5_ff(m,f,r,i,d[n+0],7,-680876936),f,r,d[n+1],12,-389564586),m,f,d[n+2],17,606105819),i,m,d[n+3],22,-1044525330),r=md5_ff(r,i=md5_ff(i,m=md5_ff(m,f,r,i,d[n+4],7,-176418897),f,r,d[n+5],12,1200080426),m,f,d[n+6],17,-1473231341),i,m,d[n+7],22,-45705983),r=md5_ff(r,i=md5_ff(i,m=md5_ff(m,f,r,i,d[n+8],7,1770035416),f,r,d[n+9],12,-1958414417),m,f,d[n+10],17,-42063),i,m,d[n+11],22,-1990404162),r=md5_ff(r,i=md5_ff(i,m=md5_ff(m,f,r,i,d[n+12],7,1804603682),f,r,d[n+13],12,-40341101),m,f,d[n+14],17,-1502002290),i,m,d[n+15],22,1236535329),r=md5_gg(r,i=md5_gg(i,m=md5_gg(m,f,r,i,d[n+1],5,-165796510),f,r,d[n+6],9,-1069501632),m,f,d[n+11],14,643717713),i,m,d[n+0],20,-373897302),r=md5_gg(r,i=md5_gg(i,m=md5_gg(m,f,r,i,d[n+5],5,-701558691),f,r,d[n+10],9,38016083),m,f,d[n+15],14,-660478335),i,m,d[n+4],20,-405537848),r=md5_gg(r,i=md5_gg(i,m=md5_gg(m,f,r,i,d[n+9],5,568446438),f,r,d[n+14],9,-1019803690),m,f,d[n+3],14,-187363961),i,m,d[n+8],20,1163531501),r=md5_gg(r,i=md5_gg(i,m=md5_gg(m,f,r,i,d[n+13],5,-1444681467),f,r,d[n+2],9,-51403784),m,f,d[n+7],14,1735328473),i,m,d[n+12],20,-1926607734),r=md5_hh(r,i=md5_hh(i,m=md5_hh(m,f,r,i,d[n+5],4,-378558),f,r,d[n+8],11,-2022574463),m,f,d[n+11],16,1839030562),i,m,d[n+14],23,-35309556),r=md5_hh(r,i=md5_hh(i,m=md5_hh(m,f,r,i,d[n+1],4,-1530992060),f,r,d[n+4],11,1272893353),m,f,d[n+7],16,-155497632),i,m,d[n+10],23,-1094730640),r=md5_hh(r,i=md5_hh(i,m=md5_hh(m,f,r,i,d[n+13],4,681279174),f,r,d[n+0],11,-358537222),m,f,d[n+3],16,-722521979),i,m,d[n+6],23,76029189),r=md5_hh(r,i=md5_hh(i,m=md5_hh(m,f,r,i,d[n+9],4,-640364487),f,r,d[n+12],11,-421815835),m,f,d[n+15],16,530742520),i,m,d[n+2],23,-995338651),r=md5_ii(r,i=md5_ii(i,m=md5_ii(m,f,r,i,d[n+0],6,-198630844),f,r,d[n+7],10,1126891415),m,f,d[n+14],15,-1416354905),i,m,d[n+5],21,-57434055),r=md5_ii(r,i=md5_ii(i,m=md5_ii(m,f,r,i,d[n+12],6,1700485571),f,r,d[n+3],10,-1894986606),m,f,d[n+10],15,-1051523),i,m,d[n+1],21,-2054922799),r=md5_ii(r,i=md5_ii(i,m=md5_ii(m,f,r,i,d[n+8],6,1873313359),f,r,d[n+15],10,-30611744),m,f,d[n+6],15,-1560198380),i,m,d[n+13],21,1309151649),r=md5_ii(r,i=md5_ii(i,m=md5_ii(m,f,r,i,d[n+4],6,-145523070),f,r,d[n+11],10,-1120210379),m,f,d[n+2],15,718787259),i,m,d[n+9],21,-343485551),m=safe_add(m,h),f=safe_add(f,t),r=safe_add(r,g),i=safe_add(i,e)}return Array(m,f,r,i)}function md5_cmn(d,_,m,f,r,i){return safe_add(bit_rol(safe_add(safe_add(_,d),safe_add(f,i)),r),m)}function md5_ff(d,_,m,f,r,i,n){return md5_cmn(_&m|~_&f,d,_,r,i,n)}function md5_gg(d,_,m,f,r,i,n){return md5_cmn(_&f|m&~f,d,_,r,i,n)}function md5_hh(d,_,m,f,r,i,n){return md5_cmn(_^m^f,d,_,r,i,n)}function md5_ii(d,_,m,f,r,i,n){return md5_cmn(m^(_|~f),d,_,r,i,n)}function safe_add(d,_){var m=(65535&d)+(65535&_);return(d>>16)+(_>>16)+(m>>16)<<16|65535&m}function bit_rol(d,_){return d<<_|d>>>32-_}
</script>

</body>
</html>